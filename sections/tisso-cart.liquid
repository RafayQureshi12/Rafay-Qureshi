<section id="tisso-cart-drawer" class="tisso-cart">
  <!-- Overlay -->
  <div class="tisso-cart-overlay"></div>

  <!-- Drawer -->
  <div class="tisso-cart-panel">
    <div class="tisso-cart-header">
      <h2>Your Cart</h2>
      <button id="tisso-cart-close">✕</button>
    </div>

    <div id="tisso-cart-items" class="tisso-cart-items">
      <!-- Cart items injected here -->
    </div>

    <div class="tisso-cart-footer">
      <p><strong>Total:</strong> <span id="tisso-cart-total">€0.00</span></p>
      <a href="/checkout" class="tisso-checkout-btn">Checkout</a>
    </div>
  </div>
</section>

<style>
/* ===== CART BASE ===== */
.tisso-cart {
  position: fixed;
  inset: 0;
  z-index: 999999;
  pointer-events: none;
  font-family: sans-serif;
  visibility: hidden;
}

/* ===== OVERLAY ===== */
.tisso-cart-overlay {
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,0.5);
  opacity: 0;
  transition: opacity 0.3s ease;
}

/* ===== PANEL ===== */
.tisso-cart-panel {
  position: absolute;
  top: 0;
  right: -420px;
  width: 100%;
  max-width: 400px;
  height: 100%;
  background: #fff;
  display: flex;
  flex-direction: column;
  transition: right 0.35s ease;
  box-shadow: -2px 0 10px rgba(0,0,0,0.1);
}

/* ===== ACTIVE STATE ===== */
.tisso-cart.active {
  pointer-events: auto;
  visibility: visible;
}

.tisso-cart.active .tisso-cart-overlay {
  opacity: 1;
}

.tisso-cart.active .tisso-cart-panel {
  right: 0;
}

/* ===== HEADER & FOOTER ===== */
.tisso-cart-header {
  padding: 20px;
  border-bottom: 1px solid #eee;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: #fff;
}

.tisso-cart-header h2 {
  margin: 0;
  font-size: 18px;
  font-weight: 600;
}

.tisso-cart-footer {
  padding: 20px;
  border-top: 1px solid #eee;
  margin-top: auto;
  background: #fff;
}

#tisso-cart-close {
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  padding: 0;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #000;
}

/* ===== ITEMS ===== */
.tisso-cart-items {
  padding: 20px;
  overflow-y: auto;
  flex: 1;
}

.cart-item {
  display: flex;
  gap: 15px;
  padding: 15px 0;
  border-bottom: 1px solid #f0f0f0;
}

.cart-item:last-child {
  border-bottom: none;
}

.cart-item img {
  width: 80px;
  height: 100px;
  object-fit: cover;
  flex-shrink: 0;
}

.cart-item-content {
  flex: 1;
}

.cart-item-content p {
  margin: 0 0 5px 0;
  font-size: 14px;
}

.cart-item-title {
  font-weight: 600;
  font-size: 14px;
  margin-bottom: 5px;
}

.cart-item-variant {
  color: #666;
  font-size: 13px;
  margin-bottom: 5px;
}

.cart-item-price {
  font-weight: 600;
  font-size: 14px;
  margin-top: 8px;
}

/* ===== CHECKOUT ===== */
.tisso-checkout-btn {
  display: block;
  width: 100%;
  background: #000;
  color: #fff;
  text-align: center;
  padding: 15px;
  text-decoration: none;
  font-weight: 600;
  font-size: 14px;
  border: none;
  cursor: pointer;
  transition: background 0.3s ease;
}

.tisso-checkout-btn:hover {
  background: #333;
}

/* ===== EMPTY CART ===== */
.tisso-cart-empty {
  text-align: center;
  padding: 40px 20px;
  color: #666;
}

/* ===== RESPONSIVE ===== */
@media (max-width: 480px) {
  .tisso-cart-panel {
    max-width: 100%;
    right: -100%;
  }
}
</style>

<script>
(function () {
  'use strict';
  
  console.log('Tisso Cart Script Loading...');
  
  const cartDrawer = document.getElementById('tisso-cart-drawer');
  const cartItemsEl = document.getElementById('tisso-cart-items');
  const cartTotalEl = document.getElementById('tisso-cart-total');
  const closeBtn = document.getElementById('tisso-cart-close');
  const overlay = cartDrawer.querySelector('.tisso-cart-overlay');

  function openCart() {
    console.log('Opening cart drawer');
    cartDrawer.classList.add('active');
    document.body.style.overflow = 'hidden';
  }

  function closeCart() {
    console.log('Closing cart drawer');
    cartDrawer.classList.remove('active');
    document.body.style.overflow = '';
  }

  // Close on escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && cartDrawer.classList.contains('active')) {
      closeCart();
    }
  });

  closeBtn.addEventListener('click', closeCart);
  overlay.addEventListener('click', closeCart);

  async function loadCart() {
    console.log('Loading cart data...');
    try {
      const response = await fetch('/cart.js');
      const cart = await response.json();

      cartItemsEl.innerHTML = '';
      cartTotalEl.textContent = (cart.total_price / 100).toFixed(2) + '€';

      if (!cart.items.length) {
        cartItemsEl.innerHTML = '<div class="tisso-cart-empty"><p>Your cart is empty</p></div>';
        return;
      }

      cart.items.forEach(item => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'cart-item';
        
        itemDiv.innerHTML = `
          <img src="${item.image}" alt="${item.title}" 
               onerror="this.src='//cdn.shopify.com/s/files/1/placeholder_120x.png?height=100&width=80'">
          <div class="cart-item-content">
            <p class="cart-item-title">${item.product_title}</p>
            <p class="cart-item-variant">${item.variant_title || 'Default'}</p>
            <p>Quantity: ${item.quantity}</p>
            <p class="cart-item-price">${(item.line_price / 100).toFixed(2)}€</p>
          </div>
        `;
        
        cartItemsEl.appendChild(itemDiv);
      });
      
    } catch (error) {
      console.error('Error loading cart:', error);
      cartItemsEl.innerHTML = '<div class="tisso-cart-empty"><p>Error loading cart</p></div>';
    }
  }

  // Listen for cart update events
  document.addEventListener('tisso:cart-updated', (event) => {
    console.log('Cart updated event received:', event.detail);
    loadCart();
    openCart();
  });

  // Also listen to Shopify events
  document.addEventListener('cart:updated', (event) => {
    console.log('Shopify cart updated event received');
    loadCart();
    openCart();
  });

  // Listen for custom open event if needed elsewhere
  document.addEventListener('tisso:open-cart', () => {
    loadCart();
    openCart();
  });

  // Close cart when clicking outside on mobile
  document.addEventListener('click', (e) => {
    if (cartDrawer.classList.contains('active') && 
        e.target === overlay) {
      closeCart();
    }
  });

  // Initial load on page load
  document.addEventListener('DOMContentLoaded', () => {
    console.log('DOM loaded, initializing cart');
    loadCart();
  });

  // If DOM already loaded
  if (document.readyState === 'complete' || document.readyState === 'interactive') {
    setTimeout(loadCart, 100);
  }

  // Make functions globally available if needed
  window.tissoCart = {
    open: openCart,
    close: closeCart,
    refresh: loadCart
  };
  
  console.log('Tisso Cart Script Loaded Successfully');
})();
</script>
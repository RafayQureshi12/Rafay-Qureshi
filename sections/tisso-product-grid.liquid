{% comment %}
Tisso Product Grid - Fixed Version
{% endcomment %}

<section class="tisso-grid">
  <h2 class="tisso-grid__title">{{ section.settings.section_title }}</h2>

  <div class="tisso-grid__container">
    {% for product in collections.all.products limit: 8 %}
      <div class="tisso-card">
        <img
          src="{{ product.featured_image | image_url: width: 600 }}"
          alt="{{ product.title }}"
          class="tisso-card__image"
          data-product='{{ product | json | escape }}'
        >
        <h4 class="tisso-card__title">{{ product.title }}</h4>
        <p class="tisso-card__price">{{ product.price | money }}</p>
        <button class="tisso-quick-view" data-product='{{ product | json | escape }}'>
          Quick View
        </button>
      </div>
    {% endfor %}
  </div>
</section>

<!-- POPUP -->
<div class="tisso-popup-overlay" id="popupOverlay">
  <div class="tisso-popup">
    <div class="tisso-popup__content">
      <div class="tisso-popup__layout">
        <div class="tisso-popup__left">
          <img id="popupImage" class="tisso-popup__image" src="" alt="">
        </div>
        <div class="tisso-popup__right">
          <button class="tisso-popup__close" id="closePopup" aria-label="Close">&times;</button>
          <h3 class="tisso-popup__title" id="popupTitle"></h3>
          <p class="tisso-popup__price" id="popupPrice"></p>
          <p class="tisso-popup__description" id="popupDescription"></p>
          <div class="tisso-popup__variants" id="popupVariants"></div>
          <button class="tisso-popup__add-to-cart" id="addToCart">ADD TO CART -></button>
          <div class="tisso-popup__message" id="cartMessage"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.tisso-grid {
  padding: 40px 20px;
  max-width: 1400px;
  margin: 0 auto;
}

.tisso-grid__title {
  font-size: 32px;
  font-weight: 400;
  margin-bottom: 30px;
  text-align: left;
  color: #333;
}

.tisso-grid__container {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 20px;
}

.tisso-card {
  text-align: center;
}

.tisso-card__image {
  width: 100%;
  cursor: pointer;
  display: block;
}

.tisso-card__title {
  font-size: 14px;
  font-weight: 600;
  margin: 10px 0 4px;
}

.tisso-card__price {
  font-size: 14px;
  color: #333;
  margin: 0 0 10px;
}

.tisso-quick-view {
  margin-top: 10px;
  padding: 10px 16px;
  border: 1px solid #ddd;
  background: #fff;
  cursor: pointer;
}

.tisso-popup-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.5);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 99999;
  padding: 20px;
}

.tisso-popup {
  background: white;
  max-width: 720px;
  width: 100%;
  padding: 0;
}

.tisso-popup__layout {
  display: grid;
  grid-template-columns: 1fr 1fr;
}

.tisso-popup__left {
  background: #f4f4f4;
}

.tisso-popup__image {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}

.tisso-popup__right {
  padding: 28px;
  position: relative;
}

.tisso-popup__close {
  position: absolute;
  right: 15px;
  top: 10px;
  font-size: 20px;
  background: none;
  border: none;
  cursor: pointer;
}

.tisso-popup__title {
  font-size: 18px;
  font-weight: 600;
}

.tisso-popup__price {
  font-size: 18px;
  margin: 6px 0 10px;
}

.tisso-popup__description {
  font-size: 13px;
  color: #666;
}

.tisso-popup__add-to-cart {
  margin-top: 15px;
  background: black;
  color: white;
  padding: 14px;
  width: 100%;
  font-weight: 600;
  border: none;
  cursor: pointer;
}

.variant-group {
  margin-top: 15px;
}

.variant-group button {
  margin: 5px 5px 0 0;
  padding: 8px 16px;
  border: 1px solid #ddd;
  background: white;
  cursor: pointer;
}

.variant-group button.active {
  background: #111;
  color: white;
  border-color: #111;
}

.tisso-popup__message {
  margin-top: 12px;
  font-size: 13px;
  color: #111;
}

@media (max-width: 900px) {
  .tisso-grid__container {
    grid-template-columns: repeat(2, 1fr);
  }

  .tisso-popup__layout {
    grid-template-columns: 1fr;
  }
}
</style>

<script>
(function() {
  'use strict';

  const overlay = document.getElementById('popupOverlay');
  const closeBtn = document.getElementById('closePopup');

  let currentProduct = null;
  let selectedOptions = {};

  document.querySelectorAll('.tisso-quick-view, .tisso-card__image').forEach(function(el) {
    el.addEventListener('click', function() {
      const product = JSON.parse(el.dataset.product);
      openPopup(product);
    });
  });

  function openPopup(product) {
    currentProduct = product;
    selectedOptions = {};

    const image = product.featured_image || (product.images && product.images[0]) || '';
    document.getElementById('popupImage').src = image;
    document.getElementById('popupTitle').innerText = product.title;
    document.getElementById('popupPrice').innerText = formatPrice(product.price);
    document.getElementById('popupDescription').innerText = stripHtml(product.description || '');

    renderVariants(product);
    overlay.style.display = 'flex';
  }

  function renderVariants(product) {
    const container = document.getElementById('popupVariants');
    container.innerHTML = '';

    if (!product.options || product.options.length === 0) {
      return;
    }

    product.options.forEach(function(option, index) {
      const group = document.createElement('div');
      group.className = 'variant-group';

      const title = document.createElement('p');
      title.innerText = option;
      group.appendChild(title);

      const values = uniqueOptionValues(product.variants, index);

      values.forEach(function(value) {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.innerText = value;

        btn.onclick = function() {
          selectedOptions[index] = value;
          group.querySelectorAll('button').forEach(function(b) {
            b.classList.remove('active');
          });
          btn.classList.add('active');
        };

        group.appendChild(btn);
      });

      container.appendChild(group);
    });
  }

  document.getElementById('addToCart').onclick = function() {
    if (!currentProduct || !currentProduct.variants) {
      return;
    }

    const variant = currentProduct.variants.find(function(v) {
      return v.options.every(function(opt, i) {
        return selectedOptions[i] === opt;
      });
    }) || currentProduct.variants[0];

    fetch('/cart/add.js', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        id: variant.id,
        quantity: 1
      })
    })
    .then(function(res) { return res.json(); })
    .then(function() {
      document.getElementById('cartMessage').innerText = 'Added to cart';
    });
  };

  closeBtn.onclick = function() {
    overlay.style.display = 'none';
  };

  overlay.onclick = function(e) {
    if (e.target === overlay) {
      overlay.style.display = 'none';
    }
  };

  function uniqueOptionValues(variants, index) {
    const values = [];
    variants.forEach(function(v) {
      const value = v.options[index];
      if (values.indexOf(value) === -1) {
        values.push(value);
      }
    });
    return values;
  }

  function formatPrice(cents) {
    return (cents / 100).toLocaleString('de-DE', {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    }) + '\\u20ac';
  }

  function stripHtml(html) {
    const tmp = document.createElement('div');
    tmp.innerHTML = html;
    return tmp.textContent || tmp.innerText || '';
  }
})();
</script>

{% schema %}
{
  "name": "Tisso Product Grid",
  "class": "tisso-product-grid-section",
  "settings": [
    {
      "type": "text",
      "id": "section_title",
      "label": "Section Title",
      "default": "Tisso vision in the wild"
    }
  ],
  "presets": [
    {
      "name": "Tisso Product Grid"
    }
  ]
}
{% endschema %}

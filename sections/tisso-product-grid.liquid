{% comment %}
Custom Product Grid + Popup
Vanilla JS only - Enhanced Version
Features:
- 3x2 grid on desktop, 2x3 on mobile
- Full product popup with variants
- Add to cart functionality
- Auto-add Soft Winter Jacket when Black + Medium selected
{% endcomment %}

<section class="tisso-grid">
  <h2 class="tisso-grid__title">Tisso vision in the wild</h2>

  <div class="tisso-grid__container">
    {% for block in section.blocks %}
      {% assign product = block.settings.product %}
      {% if product %}
        <div class="tisso-grid__item">
          <img 
            src="{{ product.featured_image | image_url: width: 600 }}" 
            alt="{{ product.title }}"
            class="tisso-grid__image"
          >
          <button class="tisso-grid__dot" data-product='{{ product | json }}' aria-label="View {{ product.title }}"></button>
        </div>
      {% endif %}
    {% endfor %}
  </div>
</section>

<div class="tisso-popup-overlay" id="tissoPopup">
  <div class="tisso-popup">
    <button class="tisso-popup__close" id="closePopup" aria-label="Close popup">×</button>
    
    <div class="tisso-popup__content">
      <h3 class="tisso-popup__title" id="popupTitle"></h3>
      <p class="tisso-popup__price" id="popupPrice"></p>
      <p class="tisso-popup__description" id="popupDescription"></p>
      
      <div class="tisso-popup__variants" id="popupVariants"></div>
      
      <button class="tisso-popup__add-to-cart" id="addToCart">
        ADD TO CART
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M7.5 15L12.5 10L7.5 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
      
      <div class="tisso-popup__message" id="cartMessage"></div>
    </div>
  </div>
</div>

<style>
/* Grid Container */
.tisso-grid {
  padding: 40px 20px;
  max-width: 1400px;
  margin: 0 auto;
}

.tisso-grid__title {
  font-size: 32px;
  font-weight: 400;
  margin-bottom: 30px;
  text-align: left;
  color: #333;
}

.tisso-grid__container {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 20px;
  grid-auto-rows: 1fr;
}

.tisso-grid__item {
  position: relative;
  overflow: hidden;
  border-radius: 0;
  aspect-ratio: 4/5;
  cursor: pointer;
}

.tisso-grid__image {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
  transition: transform 0.3s ease;
}

.tisso-grid__item:hover .tisso-grid__image {
  transform: scale(1.05);
}

.tisso-grid__dot {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: white;
  border: none;
  border-radius: 50%;
  width: 32px;
  height: 32px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  color: #000;
  padding: 0;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
  font-size: 20px;
  font-weight: 400;
  line-height: 1;
}

.tisso-grid__dot:hover {
  background: #f0f0f0;
  transform: translate(-50%, -50%) scale(1.1);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.tisso-grid__dot::before {
  content: '+';
  font-size: 24px;
  font-weight: 300;
}

.tisso-grid__dot svg {
  display: none;
}

/* Popup Overlay */
.tisso-popup-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.7);
  justify-content: center;
  align-items: center;
  z-index: 9999;
  padding: 20px;
  animation: fadeIn 0.3s ease;
}

.tisso-popup-overlay.active {
  display: flex;
}

@keyframes fadeIn {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Popup Container */
.tisso-popup {
  background: white;
  padding: 40px;
  max-width: 500px;
  width: 100%;
  position: relative;
  border-radius: 0;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
  animation: slideUp 0.3s ease;
  max-height: 90vh;
  overflow-y: auto;
}

@keyframes slideUp {
  from {
    transform: translateY(30px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

.tisso-popup__close {
  position: absolute;
  top: 15px;
  right: 15px;
  background: none;
  border: none;
  font-size: 32px;
  cursor: pointer;
  color: #666;
  line-height: 1;
  padding: 5px 10px;
  transition: color 0.3s ease;
}

.tisso-popup__close:hover {
  color: #000;
}

.tisso-popup__content {
  margin-top: 10px;
}

.tisso-popup__title {
  font-size: 24px;
  font-weight: 600;
  margin-bottom: 10px;
  color: #333;
  line-height: 1.3;
}

.tisso-popup__price {
  font-size: 20px;
  font-weight: 700;
  margin-bottom: 15px;
  color: #000;
}

.tisso-popup__description {
  font-size: 14px;
  line-height: 1.6;
  color: #666;
  margin-bottom: 25px;
}

/* Variant Selectors */
.tisso-popup__variants {
  margin-bottom: 25px;
}

.tisso-variant-group {
  margin-bottom: 15px;
}

.tisso-variant-group__label {
  display: block;
  font-size: 13px;
  font-weight: 600;
  margin-bottom: 8px;
  color: #333;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.tisso-variant-group__select {
  width: 100%;
  padding: 12px 15px;
  font-size: 14px;
  border: 2px solid #ddd;
  border-radius: 0;
  background: white;
  cursor: pointer;
  transition: border-color 0.3s ease;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L6 6L11 1' stroke='%23333' stroke-width='2' stroke-linecap='round'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 15px center;
  padding-right: 40px;
}

.tisso-variant-group__select:hover,
.tisso-variant-group__select:focus {
  border-color: #333;
  outline: none;
}

/* Add to Cart Button */
.tisso-popup__add-to-cart {
  width: 100%;
  padding: 15px 30px;
  background: #000;
  color: white;
  border: none;
  font-size: 14px;
  font-weight: 700;
  letter-spacing: 1px;
  cursor: pointer;
  transition: background 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}

.tisso-popup__add-to-cart:hover {
  background: #333;
}

.tisso-popup__add-to-cart:disabled {
  background: #ccc;
  cursor: not-allowed;
}

.tisso-popup__add-to-cart svg {
  width: 20px;
  height: 20px;
}

/* Cart Message */
.tisso-popup__message {
  margin-top: 15px;
  padding: 12px;
  border-radius: 4px;
  font-size: 14px;
  text-align: center;
  display: none;
}

.tisso-popup__message.success {
  background: #d4edda;
  color: #155724;
  border: 1px solid #c3e6cb;
  display: block;
}

.tisso-popup__message.error {
  background: #f8d7da;
  color: #721c24;
  border: 1px solid #f5c6cb;
  display: block;
}

/* Mobile Responsive - 2 columns, dynamic rows */
@media (max-width: 768px) {
  .tisso-grid__container {
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
  }

  .tisso-grid__title {
    font-size: 24px;
    margin-bottom: 20px;
  }

  .tisso-popup {
    padding: 30px 20px;
    max-width: 95%;
  }

  .tisso-popup__title {
    font-size: 20px;
  }

  .tisso-popup__price {
    font-size: 18px;
  }

  .tisso-grid__dot {
    width: 28px;
    height: 28px;
  }

  .tisso-grid__dot::before {
    font-size: 20px;
  }
}
</style>

<script>
(function() {
  'use strict';

  // Configuration
  const SOFT_WINTER_JACKET_VARIANT_ID = 51379091996993; // Update this with actual variant ID
  
  // State
  let currentProduct = null;
  let selectedVariant = null;
  let selectedOptions = {};

  // DOM Elements
  const popup = document.getElementById('tissoPopup');
  const closeBtn = document.getElementById('closePopup');
  const addToCartBtn = document.getElementById('addToCart');
  const cartMessage = document.getElementById('cartMessage');
  const popupTitle = document.getElementById('popupTitle');
  const popupPrice = document.getElementById('popupPrice');
  const popupDescription = document.getElementById('popupDescription');
  const popupVariants = document.getElementById('popupVariants');

  // Initialize dot buttons
  function initDotButtons() {
    document.querySelectorAll('.tisso-grid__dot').forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.stopPropagation();
        const productData = this.dataset.product;
        try {
          currentProduct = JSON.parse(productData);
          openPopup(currentProduct);
        } catch (error) {
          console.error('Error parsing product data:', error);
        }
      });
    });
  }

  // Open popup with product data
  function openPopup(product) {
    // Reset state
    selectedOptions = {};
    cartMessage.style.display = 'none';
    cartMessage.className = 'tisso-popup__message';

    // Set product info
    popupTitle.textContent = product.title;
    
    // Format price
    const priceInDollars = (product.price / 100).toFixed(2);
    popupPrice.textContent = `${priceInDollars}€`;

    // Clean and set description
    const cleanDesc = product.description ? product.description.replace(/<[^>]*>/g, '').trim() : '';
    popupDescription.textContent = cleanDesc;

    // Render variant selectors
    renderVariants(product);

    // Set initial variant
    if (product.variants && product.variants.length > 0) {
      selectedVariant = product.variants[0].id;
      // Initialize selectedOptions with first variant
      product.options.forEach((opt, idx) => {
        selectedOptions[idx] = product.variants[0].options[idx];
      });
    }

    // Show popup
    popup.classList.add('active');
    document.body.style.overflow = 'hidden';
  }

  // Close popup
  function closePopup() {
    popup.classList.remove('active');
    document.body.style.overflow = '';
    currentProduct = null;
    selectedVariant = null;
    selectedOptions = {};
  }

  // Render variant selectors
  function renderVariants(product) {
    popupVariants.innerHTML = '';

    if (!product.options || product.options.length === 0) {
      return;
    }

    product.options.forEach((option, optionIndex) => {
      if (option.values && option.values.length > 0) {
        const variantGroup = document.createElement('div');
        variantGroup.className = 'tisso-variant-group';

        const label = document.createElement('label');
        label.className = 'tisso-variant-group__label';
        label.textContent = option.name + ':';
        label.setAttribute('for', `variant-${optionIndex}`);

        const select = document.createElement('select');
        select.className = 'tisso-variant-group__select';
        select.id = `variant-${optionIndex}`;

        option.values.forEach(value => {
          const optionElement = document.createElement('option');
          optionElement.value = value;
          optionElement.textContent = value;
          select.appendChild(optionElement);
        });

        // Set initial value
        if (product.variants[0].options[optionIndex]) {
          select.value = product.variants[0].options[optionIndex];
        }

        // Handle selection change
        select.addEventListener('change', function() {
          selectedOptions[optionIndex] = this.value;
          updateSelectedVariant(product);
        });

        variantGroup.appendChild(label);
        variantGroup.appendChild(select);
        popupVariants.appendChild(variantGroup);
      }
    });
  }

  // Update selected variant based on options
  function updateSelectedVariant(product) {
    const variant = product.variants.find(v => {
      return v.options.every((optionValue, idx) => {
        return optionValue === selectedOptions[idx];
      });
    });

    if (variant) {
      selectedVariant = variant.id;
      
      // Update price if variant has different price
      if (variant.price) {
        const priceInDollars = (variant.price / 100).toFixed(2);
        popupPrice.textContent = `${priceInDollars}€`;
      }
    }
  }

  // Add to cart functionality
  async function addToCart() {
    if (!selectedVariant) {
      showMessage('Please select a variant', 'error');
      return;
    }

    addToCartBtn.disabled = true;
    addToCartBtn.textContent = 'ADDING...';

    try {
      // Add main product to cart
      const response = await fetch('/cart/add.js', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          id: selectedVariant,
          quantity: 1
        })
      });

      if (!response.ok) {
        throw new Error('Failed to add to cart');
      }

      // Check if we need to add Soft Winter Jacket
      const hasBlack = Object.values(selectedOptions).some(opt => 
        opt && opt.toLowerCase() === 'black'
      );
      const hasMedium = Object.values(selectedOptions).some(opt => 
        opt && opt.toLowerCase() === 'medium'
      );

      if (hasBlack && hasMedium) {
        // Add Soft Winter Jacket automatically
        await fetch('/cart/add.js', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            id: SOFT_WINTER_JACKET_VARIANT_ID,
            quantity: 1
          })
        });
        
        showMessage('Product added to cart! Soft Winter Jacket also added as a bonus!', 'success');
      } else {
        showMessage('Product added to cart successfully!', 'success');
      }

      // Trigger cart drawer/update if your theme has it
      if (typeof window.updateCart === 'function') {
        window.updateCart();
      }
      
      // Dispatch custom event for cart update
      document.dispatchEvent(new CustomEvent('cart:updated'));

      // Close popup after delay
      setTimeout(() => {
        closePopup();
      }, 2000);

    } catch (error) {
      console.error('Error adding to cart:', error);
      showMessage('Failed to add to cart. Please try again.', 'error');
    } finally {
      addToCartBtn.disabled = false;
      addToCartBtn.innerHTML = 'ADD TO CART <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M7.5 15L12.5 10L7.5 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
    }
  }

  // Show message
  function showMessage(message, type) {
    cartMessage.textContent = message;
    cartMessage.className = `tisso-popup__message ${type}`;
    cartMessage.style.display = 'block';
  }

  // Event listeners
  closeBtn.addEventListener('click', closePopup);
  
  popup.addEventListener('click', function(e) {
    if (e.target === popup) {
      closePopup();
    }
  });

  addToCartBtn.addEventListener('click', addToCart);

  // Close on escape key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && popup.classList.contains('active')) {
      closePopup();
    }
  });

  // Initialize
  initDotButtons();

})();
</script>

{% schema %}
{
  "name": "Tisso Product Grid",
  "class": "tisso-product-grid-section",
  "settings": [
    {
      "type": "text",
      "id": "section_title",
      "label": "Section Title",
      "default": "Tisso vision in the wild"
    }
  ],
  "blocks": [
    {
      "type": "product",
      "name": "Product",
      "settings": [
        {
          "type": "product",
          "id": "product",
          "label": "Select product"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Tisso Product Grid",
      "blocks": []
    }
  ]
}
{% endschema %}

{% comment %}
Tisso Product Grid - Updated with Picture Perfect Quick Buy Popup
Matches the Orange Wide Leg design reference
{% endcomment %}

<section class="tisso-grid">
  <h2 class="tisso-grid__title">{{ section.settings.section_title }}</h2>

  <div class="tisso-grid__container">
    {% for block in section.blocks %}
      {% assign product = block.settings.product %}
      {% if product %}
        <div class="tisso-grid__item" {{ block.shopify_attributes }}>
          <img 
            src="{{ product.featured_image | image_url: width: 600 }}" 
            alt="{{ product.title }}"
            class="tisso-grid__image"
          >
          <button 
            class="tisso-grid__dot" 
            data-product-id="{{ product.id }}"
            data-product-title="{{ product.title | escape }}"
            data-product-price="{{ product.price }}"
            data-product-description="{{ product.description | strip_html | escape }}"
            data-product-handle="{{ product.handle }}"
            aria-label="View {{ product.title }}">
          </button>
        </div>
      {% endif %}
    {% endfor %}
  </div>
</section>

<!-- Popup Modal -->
<div class="tisso-popup-overlay" id="tissoPopup">
  <div class="tisso-popup">
    <button class="tisso-popup__close" id="closePopup" aria-label="Close">Ã—</button>
    
    <div class="tisso-popup__content">
      <div class="tisso-popup__left">
        <img id="popupImage" class="tisso-popup__image" src="" alt="">
      </div>
      
      <div class="tisso-popup__right">
        <h3 class="tisso-popup__title" id="popupTitle"></h3>
        <p class="tisso-popup__price" id="popupPrice"></p>
        <p class="tisso-popup__description" id="popupDescription"></p>
        
        <div class="tisso-popup__variants" id="popupVariants"></div>
        
        <button class="tisso-popup__add-to-cart" id="addToCart">
          ADD TO CART
          <span class="arrow">âŸ¶</span>
        </button>
        
        <div class="tisso-popup__message" id="cartMessage"></div>
      </div>
    </div>
  </div>
</div>

<style>
/* === GRID STYLES === */
.tisso-grid {
  padding: 40px 20px;
  max-width: 1400px;
  margin: 0 auto;
}

.tisso-grid__title {
  font-size: 32px;
  font-weight: 400;
  margin-bottom: 30px;
  text-align: left;
  color: #333;
}

.tisso-grid__container {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 20px;
  grid-auto-rows: 1fr;
}

.tisso-grid__item {
  position: relative;
  overflow: hidden;
  aspect-ratio: 4/5;
  cursor: pointer;
}

.tisso-grid__image {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
  transition: transform 0.3s ease;
}

.tisso-grid__item:hover .tisso-grid__image {
  transform: scale(1.05);
}

/* === PLUS BUTTON === */
.tisso-grid__dot {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: white;
  border: none;
  border-radius: 50%;
  width: 32px;
  height: 32px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  color: #000;
  padding: 0;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
  z-index: 10;
}

.tisso-grid__dot::before {
  content: '+';
  font-size: 24px;
  font-weight: 300;
  line-height: 1;
}

.tisso-grid__dot:hover {
  background: #f0f0f0;
  transform: translate(-50%, -50%) scale(1.15);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
}

/* === POPUP OVERLAY === */
.tisso-popup-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 99999;
  padding: 20px;
}

.tisso-popup-overlay.active {
  display: flex;
}

/* === POPUP CONTENT === */
.tisso-popup {
  background: white;
  max-width: 700px;
  width: 100%;
  position: relative;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
  max-height: 90vh;
  overflow-y: auto;
}

.tisso-popup__close {
  position: absolute;
  right: 12px;
  top: 12px;
  background: transparent;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: #000;
  line-height: 1;
  padding: 4px;
  z-index: 10;
  width: 28px;
  height: 28px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.tisso-popup__close:hover {
  opacity: 0.7;
}

.tisso-popup__content {
  display: grid;
  grid-template-columns: 1fr 1fr;
}

.tisso-popup__left {
  background: #f5f5f5;
}

.tisso-popup__image {
  width: 100%;
  height: 100%;
  display: block;
  object-fit: cover;
}

.tisso-popup__right {
  padding: 32px 28px 28px;
  display: flex;
  flex-direction: column;
}

.tisso-popup__title {
  font-size: 16px;
  font-weight: 400;
  margin: 0 0 8px 0;
  color: #000;
  line-height: 1.4;
}

.tisso-popup__price {
  font-size: 16px;
  font-weight: 400;
  margin: 0 0 16px 0;
  color: #000;
}

.tisso-popup__description {
  font-size: 12px;
  line-height: 1.6;
  color: #666;
  margin: 0 0 24px 0;
}

/* === VARIANT SELECTORS === */
.tisso-popup__variants {
  margin-bottom: auto;
  padding-bottom: 24px;
}

.tisso-variant-group {
  margin-bottom: 20px;
}

.tisso-variant-label {
  display: block;
  font-size: 13px;
  font-weight: 400;
  margin-bottom: 10px;
  color: #000;
}

.tisso-variant-select {
  width: 100%;
  padding: 14px 16px;
  font-size: 14px;
  border: 1px solid #000;
  background: white;
  cursor: pointer;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg width='10' height='6' viewBox='0 0 10 6' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L5 5L9 1' stroke='%23000' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 16px center;
  padding-right: 40px;
  font-weight: 400;
  color: #000;
}

.tisso-variant-select:focus {
  outline: none;
  border-color: #000;
}

/* === COLOR BUTTONS WITH COLOR STRIPS === */
.tisso-color-options {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 0;
  border: 1px solid #000;
  overflow: hidden;
}

.tisso-color-option {
  padding: 0;
  border: none;
  background: white;
  cursor: pointer;
  transition: all 0.2s ease;
  font-size: 14px;
  font-weight: 400;
  text-align: left;
  color: #000;
  position: relative;
  border-right: 1px solid #000;
  display: flex;
  align-items: center;
  height: 48px;
}

.tisso-color-option:last-child {
  border-right: none;
}

/* Color strip on the left side */
.tisso-color-option::before {
  content: '';
  width: 10px;
  height: 100%;
  margin-right: 12px;
  flex-shrink: 0;
}

/* Color-specific strips */
.tisso-color-option[data-value="White"]::before,
.tisso-color-option[data-value="white"]::before {
  background: #ffffff;
  border-right: 1px solid #e0e0e0;
}

.tisso-color-option[data-value="Black"]::before,
.tisso-color-option[data-value="black"]::before {
  background: #000000;
}

.tisso-color-option[data-value="Red"]::before,
.tisso-color-option[data-value="red"]::before {
  background: #ff0000;
}

.tisso-color-option[data-value="Blue"]::before,
.tisso-color-option[data-value="blue"]::before {
  background: #0000ff;
}

.tisso-color-option[data-value="Green"]::before,
.tisso-color-option[data-value="green"]::before {
  background: #00ff00;
}

.tisso-color-option[data-value="Navy"]::before,
.tisso-color-option[data-value="navy"]::before {
  background: #001f3f;
}

.tisso-color-option[data-value="Gray"]::before,
.tisso-color-option[data-value="grey"]::before,
.tisso-color-option[data-value="Gray"]::before {
  background: #808080;
}

.tisso-color-option[data-value="Beige"]::before,
.tisso-color-option[data-value="beige"]::before {
  background: #f5f5dc;
}

.tisso-color-option[data-value="Brown"]::before,
.tisso-color-option[data-value="brown"]::before {
  background: #8b4513;
}

.tisso-color-option[data-value="Pink"]::before,
.tisso-color-option[data-value="pink"]::before {
  background: #ffc0cb;
}

.tisso-color-option[data-value="Yellow"]::before,
.tisso-color-option[data-value="yellow"]::before {
  background: #ffff00;
}

.tisso-color-option[data-value="Orange"]::before,
.tisso-color-option[data-value="orange"]::before {
  background: #ffa500;
}

.tisso-color-option[data-value="Purple"]::before,
.tisso-color-option[data-value="purple"]::before {
  background: #800080;
}

/* Hover effect - turn black */
.tisso-color-option:hover {
  background: #000;
  color: #fff;
}

/* Selected state */
.tisso-color-option.selected {
  background: #000;
  color: #fff;
}

.tisso-color-option:disabled {
  opacity: 0.3;
  cursor: not-allowed;
  background: white;
  color: #000;
}

.tisso-color-option:disabled:hover {
  background: white;
  color: #000;
}

/* === ADD TO CART BUTTON === */
.tisso-popup__add-to-cart {
  width: 100%;
  padding: 16px 24px;
  background: #000;
  color: #fff;
  border: none;
  font-size: 14px;
  font-weight: 400;
  letter-spacing: 0.5px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  transition: background 0.3s ease;
  margin-top: auto;
}

.tisso-popup__add-to-cart:hover {
  background: #FFF544;
  color: #000
}

.tisso-popup__add-to-cart:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.tisso-popup__add-to-cart .arrow {
  font-size: 16px;
  transition: transform 0.3s ease;
}

.tisso-popup__add-to-cart:hover .arrow {
  transform: translateX(4px);
}

/* === MESSAGE STYLES === */
.tisso-popup__message {
  margin-top: 12px;
  padding: 10px;
  text-align: center;
  font-size: 13px;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.tisso-popup__message.success {
  opacity: 1;
  color: #2d7a2d;
  background: #e8f5e8;
}

.tisso-popup__message.error {
  opacity: 1;
  color: #c41e3a;
  background: #ffeaee;
}

/* === MOBILE RESPONSIVE === */
@media (max-width: 768px) {
  .tisso-grid__container {
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
  }
  
  .tisso-grid__title {
    font-size: 24px;
    margin-bottom: 20px;
  }
  
  /* MOBILE POPUP - SAME LAYOUT AS DESKTOP */
  .tisso-popup {
    max-width: 95%;
    margin: auto;
  }
  
  .tisso-popup__content {
    grid-template-columns: 1fr 1fr;
  }
  
  .tisso-popup__right {
    padding: 24px 20px 20px;
  }
  
  .tisso-popup__title {
    font-size: 14px;
  }
  
  .tisso-popup__price {
    font-size: 14px;
    margin-bottom: 12px;
  }
  
  .tisso-popup__description {
    font-size: 11px;
    margin-bottom: 16px;
  }
  
  .tisso-variant-label {
    font-size: 12px;
    margin-bottom: 8px;
  }
  
  .tisso-variant-select,
  .tisso-color-option {
    font-size: 13px;
  }
  
  .tisso-color-option {
    height: 44px;
  }
  
  .tisso-color-option::before {
    width: 70px;
  }
  
  .tisso-popup__add-to-cart {
    padding: 14px 20px;
    font-size: 13px;
  }
  
  .tisso-popup__variants {
    padding-bottom: 16px;
  }
  
  .tisso-variant-group {
    margin-bottom: 16px;
  }
}

@media (max-width: 480px) {
  .tisso-grid__container {
    grid-template-columns: 1fr;
  }
  
  .tisso-popup__content {
    grid-template-columns: 1fr 1fr;
  }
  
  .tisso-popup__right {
    padding: 20px 16px 16px;
  }
  
  .tisso-popup__title {
    font-size: 13px;
  }
  
  .tisso-popup__price {
    font-size: 13px;
  }
  
  .tisso-variant-select {
    padding: 11px 12px;
    font-size: 12px;
  }
  
  .tisso-color-option {
    font-size: 12px;
    height: 42px;
  }
  
  .tisso-color-option::before {
    width: 10px;
  }
}
</style>

<script>
(function() {
  'use strict';

  // ===== CONFIGURATION =====
  const SOFT_WINTER_JACKET_VARIANT_ID = 48942836867395;

  // ===== DOM ELEMENTS =====
  const popup = document.getElementById('tissoPopup');
  const closeBtn = document.getElementById('closePopup');
  const addToCartBtn = document.getElementById('addToCart');
  const cartMessage = document.getElementById('cartMessage');
  const popupImage = document.getElementById('popupImage');
  const popupTitle = document.getElementById('popupTitle');
  const popupPrice = document.getElementById('popupPrice');
  const popupDescription = document.getElementById('popupDescription');
  const popupVariants = document.getElementById('popupVariants');

  // ===== STATE =====
  let currentProductData = null;
  let currentProductHandle = null;
  let selectedVariantId = null;
  let selectedOptions = {};

  // ===== INIT =====
  function initButtons() {
    const dots = document.querySelectorAll('.tisso-grid__dot');
    console.log('Found', dots.length, 'product dots');
    
    dots.forEach(function(dot) {
      dot.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const productHandle = this.getAttribute('data-product-handle');
        const productId = this.getAttribute('data-product-id');
        
        console.log('Dot clicked for product:', productHandle);
        
        if (productHandle) {
          loadProductData(productHandle);
        } else {
          console.error('No product handle found');
        }
      });
    });
  }

  // ===== LOAD PRODUCT DATA =====
  function loadProductData(handle) {
    console.log('Loading product:', handle);
    currentProductHandle = handle;
    
    fetch('/products/' + handle + '.js')
      .then(function(res) { return res.json(); })
      .then(function(product) {
        console.log('Product loaded:', product);
        currentProductData = product;
        renderPopup(product);
        openPopup();
      })
      .catch(function(err) {
        console.error('Error loading product:', err);
      });
  }

  // ===== RENDER POPUP =====
  function renderPopup(product) {
    // Set basic info
    popupImage.src = product.featured_image;
    popupImage.alt = product.title;
    popupTitle.textContent = product.title;
    popupPrice.textContent = formatPrice(product.price);
    popupDescription.textContent = stripHtml(product.description);

    // Clear variants container
    popupVariants.innerHTML = '';
    selectedOptions = {};
    
    // If only one variant, select it immediately
    if (product.variants.length === 1) {
      selectedVariantId = product.variants[0].id;
      console.log('Single variant product, auto-selected:', selectedVariantId);
      return;
    }

    // Build variant selectors
    const optionNames = product.options.map(opt => opt.name);
    console.log('Product options:', optionNames);

    optionNames.forEach(function(optionName, index) {
      const optionPosition = index + 1;
      const values = getUniqueOptionValues(product, optionPosition);
      
      console.log('Option', optionName, 'values:', values);

      const group = document.createElement('div');
      group.className = 'tisso-variant-group';

      const label = document.createElement('label');
      label.className = 'tisso-variant-label';
      label.textContent = optionName;
      group.appendChild(label);

      // Special handling for Color option
      if (optionName.toLowerCase() === 'color' || optionName.toLowerCase() === 'colour') {
        const colorContainer = document.createElement('div');
        colorContainer.className = 'tisso-color-options';
        
        values.forEach(function(value) {
          const btn = document.createElement('button');
          btn.className = 'tisso-color-option';
          btn.textContent = value;
          btn.setAttribute('data-option-name', optionName);
          btn.setAttribute('data-value', value);
          btn.type = 'button';
          
          btn.addEventListener('click', function() {
            // Remove selected from siblings
            colorContainer.querySelectorAll('.tisso-color-option').forEach(function(b) {
              b.classList.remove('selected');
            });
            
            // Add selected to clicked
            this.classList.add('selected');
            
            // Update selection
            selectedOptions[optionName] = value;
            console.log('Color selected:', value);
            updateSelectedVariant();
            updateAvailability();
          });
          
          colorContainer.appendChild(btn);
        });
        
        group.appendChild(colorContainer);
      } else {
        // Dropdown for other options (Size, etc.)
        const select = document.createElement('select');
        select.className = 'tisso-variant-select';
        select.setAttribute('data-option-name', optionName);

        const placeholder = document.createElement('option');
        placeholder.value = '';
        placeholder.textContent = 'Choose your ' + optionName.toLowerCase();
        placeholder.disabled = true;
        placeholder.selected = true;
        select.appendChild(placeholder);

        values.forEach(function(value) {
          const option = document.createElement('option');
          option.value = value;
          option.textContent = value;
          select.appendChild(option);
        });

        select.addEventListener('change', function() {
          selectedOptions[optionName] = this.value;
          console.log('Option selected:', optionName, '=', this.value);
          updateSelectedVariant();
          updateAvailability();
        });

        group.appendChild(select);
      }

      popupVariants.appendChild(group);
    });
  }

  // ===== GET UNIQUE OPTION VALUES =====
  function getUniqueOptionValues(product, position) {
    const values = [];
    product.variants.forEach(function(variant) {
      const value = variant['option' + position];
      if (value && values.indexOf(value) === -1) {
        values.push(value);
      }
    });
    return values;
  }

  // ===== UPDATE SELECTED VARIANT =====
  function updateSelectedVariant() {
    if (!currentProductData) return;

    const optionNames = currentProductData.options.map(opt => opt.name);
    const allSelected = optionNames.every(name => selectedOptions[name]);

    if (!allSelected) {
      selectedVariantId = null;
      console.log('Not all options selected yet');
      return;
    }

    // Find matching variant
    const variant = currentProductData.variants.find(function(v) {
      return optionNames.every(function(name, index) {
        return v['option' + (index + 1)] === selectedOptions[name];
      });
    });

    if (variant) {
      selectedVariantId = variant.id;
      console.log('Variant selected:', selectedVariantId, variant);
    } else {
      selectedVariantId = null;
      console.log('No matching variant found');
    }
  }

  // ===== UPDATE AVAILABILITY =====
  function updateAvailability() {
    if (!currentProductData) return;

    const optionNames = currentProductData.options.map(opt => opt.name);
    
    // For each option, check which values are available
    optionNames.forEach(function(optionName, index) {
      const optionPosition = index + 1;
      const selector = document.querySelector('[data-option-name="' + optionName + '"]');
      
      if (!selector) return;

      if (selector.classList.contains('tisso-color-options')) {
        // Handle color buttons
        const buttons = selector.querySelectorAll('.tisso-color-option');
        buttons.forEach(function(btn) {
          const value = btn.getAttribute('data-value');
          const isAvailable = isOptionValueAvailable(optionName, value);
          btn.disabled = !isAvailable;
        });
      } else {
        // Handle dropdown
        const options = selector.querySelectorAll('option:not([disabled])');
        options.forEach(function(opt) {
          if (opt.value) {
            const isAvailable = isOptionValueAvailable(optionName, opt.value);
            opt.disabled = !isAvailable;
          }
        });
      }
    });
  }

  // ===== CHECK IF OPTION VALUE IS AVAILABLE =====
  function isOptionValueAvailable(optionName, value) {
    if (!currentProductData) return false;

    const optionNames = currentProductData.options.map(opt => opt.name);
    const optionIndex = optionNames.indexOf(optionName);
    
    if (optionIndex === -1) return false;

    const position = optionIndex + 1;

    // Find variants that match current selections + this value
    const matchingVariants = currentProductData.variants.filter(function(variant) {
      // Must match this option value
      if (variant['option' + position] !== value) return false;

      // Must match all other selected options
      return optionNames.every(function(name, i) {
        if (name === optionName) return true;
        if (!selectedOptions[name]) return true;
        return variant['option' + (i + 1)] === selectedOptions[name];
      });
    });

    // Available if at least one matching variant is in stock
    return matchingVariants.some(v => v.available);
  }

  // ===== ADD TO CART =====
  function addToCart() {
    if (!selectedVariantId) {
      showMessage('Please select all options', 'error');
      return;
    }

    const variant = currentProductData.variants.find(v => v.id === selectedVariantId);
    if (!variant || !variant.available) {
      showMessage('This variant is out of stock', 'error');
      return;
    }

    addToCartBtn.disabled = true;
    addToCartBtn.innerHTML = 'ADDING...';

    console.log('Adding to cart:', selectedVariantId);
    
    // Get selected option values
    const selectedOptionValues = currentProductData.options.map(function(opt) {
      return selectedOptions[opt.name];
    });
    
    console.log('Selected option values:', selectedOptionValues);
    
    // Convert all option values to lowercase for comparison
    const optionValuesLower = selectedOptionValues.map(opt => 
      opt ? opt.toString().toLowerCase().trim() : ''
    );
    
    console.log('Lowercase option values:', optionValuesLower);
    
    // Check for Black (handle variations)
    const hasBlack = optionValuesLower.some(opt => 
      opt === 'black' || opt === 'noir' || opt.includes('black')
    );
    
    // Check for Medium (handle variations like "M", "Med", "Medium")
    const hasMedium = optionValuesLower.some(opt => 
      opt === 'medium' || opt === 'm' || opt === 'med' || opt.includes('medium')
    );
    
    console.log('Black + Medium check:', { 
      hasBlack, 
      hasMedium, 
      optionValuesLower,
      willAddBonus: hasBlack && hasMedium 
    });
    
    // Add the main product first
    fetch('/cart/add.js', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        id: selectedVariantId,
        quantity: 1
      })
    })
    .then(function(response) {
      if (!response.ok) throw new Error('Failed to add to cart');
      return response.json();
    })
    .then(function(data) {
      console.log('Main product added to cart:', data);
      
      // If Black + Medium, add the Soft Winter Jacket
      if (hasBlack && hasMedium) {
        console.log('âœ… BLACK + MEDIUM DETECTED! Adding Soft Winter Jacket...');
        showMessage('Added to cart! Adding bonus item...', 'success');
        
        // Add Soft Winter Jacket after a short delay
        return new Promise(resolve => {
          setTimeout(() => {
            addSoftWinterJacket()
              .then(() => {
                console.log('âœ… Soft Winter Jacket added successfully');
                showMessage('Added to cart! Bonus item included!', 'success');
                
                // Dispatch cart update event
                const event = new CustomEvent('tisso:cart-updated', {
                  detail: { 
                    product: currentProductHandle,
                    variant: selectedVariantId,
                    bonusAdded: true
                  }
                });
                document.dispatchEvent(event);
                console.log('Dispatched tisso:cart-updated event with bonus');
                
                // Close popup after a delay
                setTimeout(closePopup, 2000);
                resolve();
              })
              .catch(error => {
                console.error('Error adding bonus item:', error);
                showMessage('Added to cart! (Bonus item failed)', 'success');
                
                // Still dispatch event even if bonus failed
                const event = new CustomEvent('tisso:cart-updated', {
                  detail: { 
                    product: currentProductHandle,
                    variant: selectedVariantId,
                    bonusAdded: false
                  }
                });
                document.dispatchEvent(event);
                
                setTimeout(closePopup, 1500);
                resolve();
              });
          }, 500);
        });
      } else {
        // No Black + Medium, just show success
        showMessage('Added to cart!', 'success');
        
        // Dispatch cart update event
        const event = new CustomEvent('tisso:cart-updated', {
          detail: { 
            product: currentProductHandle,
            variant: selectedVariantId,
            bonusAdded: false
          }
        });
        document.dispatchEvent(event);
        console.log('Dispatched tisso:cart-updated event');
        
        // Close popup after a delay
        setTimeout(closePopup, 1500);
        return Promise.resolve();
      }
    })
    .then(function() {
      // Refresh the cart globally
      return fetch('/cart.js')
        .then(function(res) { return res.json(); })
        .then(function(cart) {
          document.dispatchEvent(new CustomEvent('cart:updated', { detail: cart }));
          console.log('Shopify cart updated event dispatched');
        });
    })
    .catch(function(error) {
      console.error('Cart error:', error);
      showMessage('Failed to add to cart', 'error');
    })
    .finally(function() {
      addToCartBtn.disabled = false;
      addToCartBtn.innerHTML = 'ADD TO CART <span class="arrow">âŸ¶</span>';
    });
  }

  // ===== ADD SOFT WINTER JACKET =====
  function addSoftWinterJacket() {
    console.log('Attempting to add Soft Winter Jacket with variant ID:', SOFT_WINTER_JACKET_VARIANT_ID);
    console.log('Variant ID type:', typeof SOFT_WINTER_JACKET_VARIANT_ID);
    
    return fetch('/cart/add.js', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        id: SOFT_WINTER_JACKET_VARIANT_ID,
        quantity: 1
      })
    })
    .then(function(response) {
      console.log('Response status:', response.status);
      
      // Get the response body for error details
      return response.json().then(function(data) {
        console.log('Response data:', data);
        
        if (!response.ok) {
          console.error('âŒ Failed to add Soft Winter Jacket. Status:', response.status);
          console.error('Full response:', data);
          
          // Provide helpful error messages
          if (response.status === 422) {
            console.error('=== 422 ERROR DETAILS ===');
            console.error('Description:', data.description);
            console.error('Message:', data.message);
            console.error('Status:', data.status);
            
            if (data.description && data.description.includes('out of stock')) {
              console.error('ðŸ”´ REASON: The Soft Winter Jacket variant is OUT OF STOCK');
              console.error('ðŸ‘‰ Go to Shopify Admin > Products > Soft Winter Jacket and increase inventory');
            } else if (data.description && data.description.includes('not found')) {
              console.error('ðŸ”´ REASON: Variant ID', SOFT_WINTER_JACKET_VARIANT_ID, 'does not exist');
              console.error('ðŸ‘‰ Verify the variant ID is correct');
            } else {
              console.error('ðŸ”´ REASON: Unknown - Full error:', data);
              console.error('ðŸ‘‰ Check variant availability and inventory in Shopify Admin');
            }
          }
          
          throw new Error(data.description || data.message || 'Failed to add bonus item');
        }
        return data;
      });
    })
    .then(function(data) {
      console.log('âœ… Soft Winter Jacket added successfully:', data);
      return data;
    })
    .catch(function(error) {
      console.error('Catch block error:', error);
      throw error;
    });
  }

  // ===== POPUP CONTROLS =====
  function openPopup() {
    popup.classList.add('active');
    document.body.style.overflow = 'hidden';
  }

  function closePopup() {
    popup.classList.remove('active');
    document.body.style.overflow = '';
    hideMessage();
    currentProductData = null;
    currentProductHandle = null;
    selectedVariantId = null;
    selectedOptions = {};
  }

  function showMessage(text, type) {
    cartMessage.textContent = text;
    cartMessage.className = 'tisso-popup__message ' + type;
  }

  function hideMessage() {
    cartMessage.className = 'tisso-popup__message';
    cartMessage.textContent = '';
  }

  // ===== UTILITY FUNCTIONS =====
  function formatPrice(cents) {
    return (cents / 100).toFixed(2) + 'â‚¬';
  }

  function stripHtml(html) {
    const tmp = document.createElement('div');
    tmp.innerHTML = html;
    return tmp.textContent || tmp.innerText || '';
  }

  // ===== EVENT LISTENERS =====
  if (closeBtn) {
    closeBtn.addEventListener('click', closePopup);
  }

  if (popup) {
    popup.addEventListener('click', function(e) {
      if (e.target === popup) {
        closePopup();
      }
    });
  }

  if (addToCartBtn) {
    addToCartBtn.addEventListener('click', addToCart);
  }

  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && popup.classList.contains('active')) {
      closePopup();
    }
  });

  // ===== INITIALIZE =====
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initButtons);
  } else {
    initButtons();
  }

  console.log('Tisso Product Grid Script Loaded Successfully');
  console.log('Soft Winter Jacket Variant ID:', SOFT_WINTER_JACKET_VARIANT_ID);
  
})();
</script>

{% schema %}
{
  "name": "Tisso Product Grid",
  "class": "tisso-product-grid-section",
  "settings": [
    {
      "type": "text",
      "id": "section_title",
      "label": "Section Title",
      "default": "Tisso vision in the wild"
    }
  ],
  "blocks": [
    {
      "type": "product",
      "name": "Product",
      "settings": [
        {
          "type": "product",
          "id": "product",
          "label": "Select Product"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Tisso Product Grid"
    }
  ]
}
{% endschema %}
